name: telemetry-dispatch-summarize
description: |
  This action is run in a final job on the top-level workflow, after all other
  jobs are completed. This action downloads the JSON records of all jobs from
  the current run. It then associates metadata records that were uploaded with
  the telemetry-dispatch-stash-job-artifacts action with jobs. This is
  effectively label metadata. Finally, this action creates OpenTelemetry spans
  with the timing and label metadata, and sends it to the configured Tempo
  endpoint (or forwarder).
inputs:
  json_params:
    type: string
    default: "{}"
    description: "JSON string of parameters. Used to avoid 10-param limit on workflow inputs."

runs:
  using: 'composite'
  steps:
    - name: Handle empty inputs
      id: handle-empty-inputs
      shell: bash
      run: |
        echo "shared_actions_repo=${{ fromJson(inputs.json_params).shared_actions_repo || 'rapidsai/shared-actions' }}" >> $GITHUB_OUTPUT
        echo "shared_actions_ref=${{ fromJson(inputs.json_params).shared_actions_ref || 'main' }}" >> $GITHUB_OUTPUT
        echo "OTEL_SERVICE_NAME=${{ fromJson(inputs.json_params).OTEL_SERVICE_NAME || 'OTEL_SERVICE_NAME not set' }}" >> $GITHUB_OUTPUT
        echo "OTEL_EXPORTER_OTLP_ENDPOINT=${{ fromJson(inputs.json_params).OTEL_EXPORTER_OTLP_ENDPOINT || 'https://alloy.local.gha-runners.nvidia.com:4317' }}" >> $GITHUB_OUTPUT
        echo "OTEL_TRACES_EXPORTER=${{ fromJson(inputs.json_params).OTEL_TRACES_EXPORTER || 'otlp' }}" >> $GITHUB_OUTPUT
        echo "OTEL_EXPORTER_OTLP_PROTOCOL=${{ fromJson(inputs.json_params).OTEL_EXPORTER_OTLP_PROTOCOL || 'grpc' }}" >> $GITHUB_OUTPUT
    - uses: actions/checkout@v4
      with:
        repository: ${{ steps.handle-empty-inputs.outputs.shared_actions_repo }}
        ref: ${{ steps.handle-empty-inputs.outputs.shared_actions_ref }}
        path: shared-actions
    - uses: ./shared-actions/telemetry-impls/summarize
      with:
        OTEL_SERVICE_NAME: ${{ steps.handle-empty-inputs.outputs.OTEL_SERVICE_NAME }}
        OTEL_EXPORTER_OTLP_ENDPOINT: ${{ steps.handle-empty-inputs.outputs.OTEL_EXPORTER_OTLP_ENDPOINT }}
        OTEL_TRACES_EXPORTER: ${{ steps.handle-empty-inputs.outputs.OTEL_TRACES_EXPORTER }}
        OTEL_EXPORTER_OTLP_PROTOCOL: ${{ steps.handle-empty-inputs.outputs.OTEL_EXPORTER_OTLP_PROTOCOL }}
